# -*- coding: utf-8 -*-
# vim: ft=yaml
---
include:
  - project: EOLE/infra/ci-tools
    ref: stable
    file: /templates/Rules.yaml

variables:
  # `ci-tools` default branch is `stable`
  STABLE_BRANCH: master

stages:
  - deps
  - lint
  - test

# Common setup for all meteor based jobs
.meteor:
  extends: .not-on-stable
  image: hub.eole.education/proxyhub/geoffreybooth/meteor-base:2.5
  cache:
    paths:
      - node_modules/
  variables:
    METEOR_ALLOW_SUPERUSER: "true"


###############################################################################
# `deps` stage: to download and cache dependencies
###############################################################################
cache-dependencies:
  stage: deps
  extends: .meteor
  script:
    - meteor npm ci
  artifacts:
    paths:
      - node_modules/


###############################################################################
# `lint` stage: `meteor-lint`
###############################################################################
meteor-lint:
  stage: lint
  extends: .meteor
  script:
    - meteor npm install --only=dev
    - meteor npm run lint


###############################################################################
# `test` stage: `meteor-tests`
###############################################################################
meteor-tests:
  stage: test
  extends: .meteor
  script:
    - meteor npm test
